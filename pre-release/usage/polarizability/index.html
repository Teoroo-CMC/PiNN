<!--
  This Basic theme serves as an example for how to create other
  themes by demonstrating the features with minimal HTML and CSS.
  Comments like this will be through the code to explain briefly
  what each feature is and point you to the MkDocs documentation
  to find out more.
-->
<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  
  <!--
    The page_title contains the title for a page as shown in the navigation.
    Site name contains the name as defined in the mkdocs.yml
  -->
  <title>Polarizability - PiNN</title>

  <link rel="stylesheet" href="../../css/theme.css">
  <link rel="stylesheet" href="../../css/notebook.css">
  <link rel="stylesheet" href="../../css/pygments.css">
  <link rel="icon" href="data:,">
  
    <link href="../../assets/_mkdocstrings.css" rel="stylesheet">
  
    <link href="../../css/extra.css" rel="stylesheet">
  
    <link href="../../css/ansi-colours.css" rel="stylesheet">
  
    <link href="../../css/jupyter-cells.css" rel="stylesheet">
  
    <link href="../../css/pandas-dataframe.css" rel="stylesheet">
  

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,600;1,400;1,700&family=Noto+Sans:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet">
  <script
  src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
  integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E="
  crossorigin="anonymous"></script>

  <script>
    var base_url = "../..";
    $(document).ready(function(){
          $('table').wrap('<div class="table-wrapper"></div>');
    });
  </script>

  <script src="../../js/mike.js"></script>

  
    <script src="../../js/mathjax.js"></script>
  
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  
    <script src="https://cdn.jsdelivr.net/npm/mathjax@4.0.0-beta.3/tex-chtml-nofont.js"></script>
  

</head>

<body>
  <header class="header">
    <ul>
      <li id="logo">
        <a href="../.."><span>Pi</span>NN</a>
      </li>
      
      
  
  <li  class="tab" >
    <a href="../..">
      Home
    </a>
  </li>

      
      
  
  <li class="active tab" >
    <a href="../overview/">
      Usage
    </a>
  </li>

      
      
  
  <li  class="tab" >
    <a href="../../notebooks/overview/">
      Notebooks
    </a>
  </li>

      
      <li class="tools">
        
          <a id="nav-toggle" class="tool" onclick="nav_toggle()">
        
          <svg><use xlink:href="../../svg/sprite.svg#menu-2"></use></svg>
        </a>
        <script>
           function nav_toggle() {
               var bar = document.getElementById("tab-bar");
               if (bar.style.display === "none") {
                   bar.style.display = "block";
               } else {
                   bar.style.display = "none";
               }
           }
          function nav_reset() {
              var bar = document.getElementById("tab-bar");
              if (window.innerWidth>950){
                  bar.style.display = "block";
              } else {
                  bar.style.display = "none";
              }
          }
          window.onresize = nav_reset;
        </script>
        
        <a class="tool">
          <svg><use xlink:href="../../svg/sprite.svg#tag"></use></svg>
          <div class="version"></div>
        </a>
        
        
        <a class="tool" href="https://github.com/teoroo-cmc/pinn/">
          <svg><use xlink:href="../../svg/sprite.svg#brand-github"></use></svg>
          <span>teoroo-cmc/pinn</span>
        </a>
        
      </li>
    </ul>
  </header>


  <div id="main">
    <div id="tab-bar">
      <ul>
      
       
  
  <li  class="tab" >
    <a href="../..">
      Home
    </a>
  </li>

         
           <div class="nav-bar">
             <ul>
               
             </ul>
           </div>
         
      
       
  
  <li class="active tab" >
    <a href="../overview/">
      Usage
    </a>
  </li>

         
           <div class="nav-bar">
             <ul>
               
                 
                   
    <li >
      <a href="../overview/" class="">
        Overview
      </a>
    </li>

                 
                   
    <li >
      <a href="../quick_start/" class="">
        Quick Start
      </a>
    </li>

                 
                   
  <a class="nav-title" > IO </a>
  
    
    <li >
      <a href="../datasets/" class="">
        Datasets
      </a>
    </li>

  

                 
                   
  <a class="nav-title" > Networks </a>
  
    
    <li >
      <a href="../networks/" class="">
        Overview
      </a>
    </li>

  
    
    <li >
      <a href="../layers/" class="">
        Layers
      </a>
    </li>

  
    
    <li >
      <a href="../pinet/" class="">
        PiNet
      </a>
    </li>

  
    
    <li >
      <a href="../pinet2/" class="">
        PiNet2
      </a>
    </li>

  
    
    <li >
      <a href="../bpnn/" class="">
        BPNN
      </a>
    </li>

  

                 
                   
  <a class="nav-title" > Models </a>
  
    
    <li >
      <a href="../models/" class="">
        Overview
      </a>
    </li>

  
    
    <li >
      <a href="../potential/" class="">
        Potential
      </a>
    </li>

  
    
    <li >
      <a href="../dipole/" class="">
        Dipole
      </a>
    </li>

  
    
    <li class="active">
      <a href="./" class="">
        Polarizability
      </a>
    </li>

  
    
    <li >
      <a href="../custom_model/" class="">
        Customize
      </a>
    </li>

  

                 
                   
  <a class="nav-title" > CLI </a>
  
    
    <li >
      <a href="../cli/convert/" class="">
        convert
      </a>
    </li>

  
    
    <li >
      <a href="../cli/train/" class="">
        train
      </a>
    </li>

  
    
    <li >
      <a href="../cli/log/" class="">
        log
      </a>
    </li>

  
    
    <li >
      <a href="../cli/report/" class="">
        report
      </a>
    </li>

  

                 
                   
  <a class="nav-title" > Misc </a>
  
    
    <li >
      <a href="../optimizers/" class="">
        Optimizers
      </a>
    </li>

  
    
    <li >
      <a href="../visualize/" class="">
        Visualize
      </a>
    </li>

  

                 
               
             </ul>
           </div>
         
      
       
  
  <li  class="tab" >
    <a href="../../notebooks/overview/">
      Notebooks
    </a>
  </li>

         
           <div class="nav-bar">
             <ul>
               
             </ul>
           </div>
         
      
      </ul>
    </div>

    <div id="content">
      <h1 id="polarizability-model">Polarizability Model</h1>
<p>The polarizability module PiNet2-<span class="arithmatex">\(\chi\)</span> implements different models to predict the charge response kernel (CRK)
and polarizability tensor by fitting polarizability tensor data <sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>. All models output the polarizability tensor <span class="arithmatex">\(\boldsymbol{\alpha}\)</span> and CRK <span class="arithmatex">\(\boldsymbol{\chi}\)</span>. The polarizability model requires the dictionary as output from the preprocess layer as input. Listed below are the <code>model_params</code> that can be set. The EEM <sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup> and ACKS2 <sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup> models are based on the
Coulomb kernel and have support for Ewald summation if the Ewald parameters are set and <code>cell</code> 
is specified in the input data. The EEM and EtaInv models can in addition to polarizability be 
trained on the egap. </p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ewald_rc</code></td>
<td><code>None</code></td>
<td>Ewald short-range cut-off</td>
</tr>
<tr>
<td><code>ewald_kmax</code></td>
<td><code>None</code></td>
<td>Maximum k for Ewald summation</td>
</tr>
<tr>
<td><code>ewald_eta</code></td>
<td><code>None</code></td>
<td>Gaussian width for Ewald summation</td>
</tr>
<tr>
<td><code>p_scale</code></td>
<td><code>1</code></td>
<td>Polarization unit during training</td>
</tr>
<tr>
<td><code>p_unit</code></td>
<td><code>1</code></td>
<td>Output unit of polarizability during prediction (default: atomic units)</td>
</tr>
<tr>
<td><code>p_loss_multiplier</code></td>
<td><code>1</code></td>
<td>Weight of polarizability loss</td>
</tr>
<tr>
<td><code>train_egap</code></td>
<td><code>0</code></td>
<td>Whether to train on egap data</td>
</tr>
<tr>
<td><code>eval_egap</code></td>
<td><code>0</code></td>
<td>Whether to return egap predictions</td>
</tr>
</tbody>
</table>
<h2 id="model-specifications">Model specifications</h2>
<h3 id="pinnmodelspol_modelspol_eem_fn">pinn.models.pol_models.pol_eem_fn</h3>


<div class="doc doc-object doc-function">



<a id="pinn.models.pol_models.pol_eem_fn"></a>
    <div class="doc doc-contents first">

        <p>The EEM model calculates <span class="arithmatex">\(\boldsymbol{\chi}\)</span> based on electronegativity equalization. The matrix 
<span class="arithmatex">\(\boldsymbol{\eta}_\mathrm{e}\)</span> is calculated as</p>
<div class="arithmatex">\[
\begin{aligned}
(\eta_e)_{ii}&amp;= {}^{1}\mathbb{P}_i + \sqrt{\frac{2\zeta_i}{\pi}} \\
(\eta_e)_{ij} &amp;= \frac{\mathrm{erf}\left(R_{ij}\sqrt{\frac{\zeta_i\zeta_j}{\zeta_i+\zeta_j}}\right)}{R_{ij}}  \quad  \mathrm{for}~~i\neq j
\end{aligned} 
\]</div>
<p>where <span class="arithmatex">\(\zeta_i\)</span> are trainable Gaussian parameters. <span class="arithmatex">\(\boldsymbol{\chi}\)</span> is then calculated as:</p>
<div class="arithmatex">\[
\begin{aligned}
\boldsymbol{\chi} = -\boldsymbol{\eta}_\mathrm{e}^{-1} + \frac{\boldsymbol{\eta}_\mathrm{e}^{-1}\mathbf{1}\otimes\mathbf{1}^\top\boldsymbol{\eta}_\mathrm{e}^{-1}}{\mathbf{1}^\top\boldsymbol{\eta}_\mathrm{e}^{-1} \mathbf{1}}
\end{aligned}
\]</div>

            <details class="quote">
              <summary>Source code in <code>pinn/models/pol_models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@export_pol_model</span><span class="p">(</span><span class="s1">&#39;pol_eem_model&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pol_eem_fn</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sa">R</span><span class="sd">&quot;&quot;&quot; The EEM model calculates $\boldsymbol{\chi}$ based on electronegativity equalization. The matrix </span>
<span class="sd">    $\boldsymbol{\eta}_\mathrm{e}$ is calculated as</span>

<span class="sd">    $$</span>
<span class="sd">    \begin{aligned}</span>
<span class="sd">    (\eta_e)_{ii}&amp;= {}^{1}\mathbb{P}_i + \sqrt{\frac{2\zeta_i}{\pi}} \\</span>
<span class="sd">    (\eta_e)_{ij} &amp;= \frac{\mathrm{erf}\left(R_{ij}\sqrt{\frac{\zeta_i\zeta_j}{\zeta_i+\zeta_j}}\right)}{R_{ij}}  \quad  \mathrm{for}~~i\neq j</span>
<span class="sd">    \end{aligned} </span>
<span class="sd">    $$</span>

<span class="sd">    where $\zeta_i$ are trainable Gaussian parameters. $\boldsymbol{\chi}$ is then calculated as:</span>

<span class="sd">    $$</span>
<span class="sd">    \begin{aligned}</span>
<span class="sd">    \boldsymbol{\chi} = -\boldsymbol{\eta}_\mathrm{e}^{-1} + \frac{\boldsymbol{\eta}_\mathrm{e}^{-1}\mathbf{1}\otimes\mathbf{1}^\top\boldsymbol{\eta}_\mathrm{e}^{-1}}{\mathbf{1}^\top\boldsymbol{\eta}_\mathrm{e}^{-1} \mathbf{1}}</span>
<span class="sd">    \end{aligned}</span>
<span class="sd">    $$</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#params[&#39;network&#39;][&#39;params&#39;].update({&#39;ppred&#39;: 1, &#39;ipred&#39;: 0})</span>
    <span class="n">network</span> <span class="o">=</span> <span class="n">get_network</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">])</span>
    <span class="n">tensors</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">ppred</span> <span class="o">=</span> <span class="n">network</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>

    <span class="c1"># construct EEM, using trainale sigma</span>
    <span class="n">atom_rind</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">make_indices</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">nbatch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">nmax</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">sigma_a</span><span class="p">,</span> <span class="n">sigma_e</span> <span class="o">=</span> <span class="n">make_sigma</span><span class="p">(</span><span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;elems&#39;</span><span class="p">],</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;atom_types&#39;</span><span class="p">]):</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sigma/</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">sigma_e</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">cell</span> <span class="o">=</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">tensors</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">ewald_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;ewald_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;kmax&#39;</span><span class="p">,</span> <span class="s1">&#39;rc&#39;</span><span class="p">,</span> <span class="s1">&#39;eta&#39;</span><span class="p">]}</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">make_E</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">],</span> <span class="n">sigma_a</span><span class="p">,</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="n">cell</span><span class="p">,</span>
               <span class="o">**</span><span class="n">ewald_params</span><span class="p">)</span><span class="o">/</span><span class="n">ang2bohr</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">make_diag</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ppred</span><span class="p">),</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">make_dummy</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">)</span>
    <span class="n">eta</span>    <span class="o">=</span> <span class="n">E</span><span class="o">+</span><span class="n">J</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">make_R</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">],</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">)</span><span class="o">*</span><span class="n">ang2bohr</span>
    <span class="n">etaInv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">eta</span><span class="o">+</span><span class="n">D</span><span class="p">)</span><span class="o">-</span><span class="n">D</span>
    <span class="n">egap</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij-&gt;a&#39;</span><span class="p">,</span><span class="n">etaInv</span><span class="p">)</span>
    <span class="n">chi</span>    <span class="o">=</span> <span class="n">make_lrf</span><span class="p">(</span><span class="n">etaInv</span><span class="p">)</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bix,bij,bjy-&gt;bxy&#39;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">chi</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">alpha</span><span class="p">,</span> <span class="s1">&#39;egap&#39;</span><span class="p">:</span> <span class="n">egap</span><span class="p">,</span> <span class="s1">&#39;chi&#39;</span><span class="p">:</span><span class="n">chi</span><span class="p">,</span> <span class="s1">&#39;eta&#39;</span><span class="p">:</span> <span class="n">eta</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="pinnmodelspol_modelspol_acks2_fn">pinn.models.pol_models.pol_acks2_fn</h3>


<div class="doc doc-object doc-function">



<a id="pinn.models.pol_models.pol_acks2_fn"></a>
    <div class="doc doc-contents first">

        <p>The ACKS2 model calculates <span class="arithmatex">\(\boldsymbol{\chi}\)</span> based on the Dyson equation: </p>
<div class="arithmatex">\[
\begin{aligned}
\boldsymbol{\chi} = \boldsymbol{\chi}_\mathrm{s}\left[ \mathbf{I} - \boldsymbol{\eta}_\mathrm{e}\boldsymbol{\chi}_\mathrm{s}\right]^{-1}. \\
\end{aligned} 
\]</div>
<p>where <span class="arithmatex">\(\boldsymbol{\eta}_\mathrm{e}\)</span> is calculated as in the EEM model and <span class="arithmatex">\(\boldsymbol{\chi}_\mathrm{s}\)</span> is calculated from output interactions <span class="arithmatex">\(\mathbb{I}_{ij}\)</span>:</p>
<div class="arithmatex">\[
\begin{aligned}
\boldsymbol{\chi}_s &amp;= |\mathbb{I}|+|\mathbb{I}|^\top -
\mathrm{diag}\left(|\mathbb{I}_{ij}|\mathbf{1}+|\mathbb{I}_{ij}|^\top\mathbf{1}\right) \\
\mathbb{I}_{ij} &amp;= {}^{1}\mathbb{I}_{ij} + \langle {}^{3}\mathbb{I}_{ijx}, {}^{3}\mathbb{I}_{ijx} \rangle
\end{aligned}
\]</div>

            <details class="quote">
              <summary>Source code in <code>pinn/models/pol_models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@export_pol_model</span><span class="p">(</span><span class="s1">&#39;pol_acks2_model&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pol_acks2_fn</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sa">R</span><span class="sd">&quot;&quot;&quot;The ACKS2 model calculates $\boldsymbol{\chi}$ based on the Dyson equation: </span>

<span class="sd">    $$</span>
<span class="sd">    \begin{aligned}</span>
<span class="sd">    \boldsymbol{\chi} = \boldsymbol{\chi}_\mathrm{s}\left[ \mathbf{I} - \boldsymbol{\eta}_\mathrm{e}\boldsymbol{\chi}_\mathrm{s}\right]^{-1}. \\</span>
<span class="sd">    \end{aligned} </span>
<span class="sd">    $$</span>

<span class="sd">    where $\boldsymbol{\eta}_\mathrm{e}$ is calculated as in the EEM model and $\boldsymbol{\chi}_\mathrm{s}$ is calculated from output interactions $\mathbb{I}_{ij}$:</span>

<span class="sd">    $$</span>
<span class="sd">    \begin{aligned}</span>
<span class="sd">    \boldsymbol{\chi}_s &amp;= |\mathbb{I}|+|\mathbb{I}|^\top -</span>
<span class="sd">    \mathrm{diag}\left(|\mathbb{I}_{ij}|\mathbf{1}+|\mathbb{I}_{ij}|^\top\mathbf{1}\right) \\</span>
<span class="sd">    \mathbb{I}_{ij} &amp;= {}^{1}\mathbb{I}_{ij} + \langle {}^{3}\mathbb{I}_{ijx}, {}^{3}\mathbb{I}_{ijx} \rangle</span>
<span class="sd">    \end{aligned}</span>
<span class="sd">    $$</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;out_extra&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;i1&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;i3&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}})</span>
    <span class="n">network</span> <span class="o">=</span> <span class="n">get_network</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">])</span>
    <span class="n">tensors</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">ppred</span><span class="p">,</span> <span class="n">ipred</span> <span class="o">=</span> <span class="n">network</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">ipred1</span> <span class="o">=</span> <span class="n">ipred</span><span class="p">[</span><span class="s1">&#39;i1&#39;</span><span class="p">]</span>
    <span class="n">ipred3</span> <span class="o">=</span> <span class="n">ipred</span><span class="p">[</span><span class="s1">&#39;i3&#39;</span><span class="p">]</span>
    <span class="n">i3norm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij,aij-&gt;aj&#39;</span><span class="p">,</span><span class="n">ipred3</span><span class="p">,</span><span class="n">ipred3</span><span class="p">)</span>
    <span class="n">ipred</span> <span class="o">=</span> <span class="n">ipred1</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij,aij-&gt;aj&#39;</span><span class="p">,</span><span class="n">ipred3</span><span class="p">,</span><span class="n">ipred3</span><span class="p">)</span>

    <span class="c1"># construct eta_e, this part should e same with EEM</span>
    <span class="n">atom_rind</span><span class="p">,</span> <span class="n">pair_rind</span> <span class="o">=</span> <span class="n">make_indices</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">nmax</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">nbatch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">sigma_a</span><span class="p">,</span> <span class="n">sigma_e</span> <span class="o">=</span> <span class="n">make_sigma</span><span class="p">(</span><span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;elems&#39;</span><span class="p">],</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;atom_types&#39;</span><span class="p">]):</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sigma/</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">sigma_e</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">cell</span> <span class="o">=</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">tensors</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">ewald_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;ewald_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;kmax&#39;</span><span class="p">,</span> <span class="s1">&#39;rc&#39;</span><span class="p">,</span> <span class="s1">&#39;eta&#39;</span><span class="p">]}</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">make_E</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">],</span> <span class="n">sigma_a</span><span class="p">,</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="n">cell</span><span class="p">,</span>
               <span class="o">**</span><span class="n">ewald_params</span><span class="p">)</span><span class="o">/</span><span class="n">ang2bohr</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">make_diag</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ppred</span><span class="p">),</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">)</span>
    <span class="n">eta_e</span> <span class="o">=</span> <span class="n">E</span><span class="o">+</span><span class="n">J</span>

    <span class="c1"># construct chi_s</span>
    <span class="n">chi_s</span> <span class="o">=</span> <span class="n">make_offdiag</span><span class="p">(</span><span class="n">pair_rind</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ipred</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span>
                         <span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">invariant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">I</span>     <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">nmax</span><span class="p">,</span> <span class="n">batch_shape</span><span class="o">=</span><span class="p">[</span><span class="n">nbatch</span><span class="p">])</span>
    <span class="n">chi</span>   <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
        <span class="n">I</span><span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bij,bjk-&gt;bik&#39;</span><span class="p">,</span> <span class="n">eta_e</span><span class="p">,</span> <span class="n">chi_s</span><span class="p">),</span> <span class="n">chi_s</span><span class="p">,</span> <span class="n">adjoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">R</span> <span class="o">=</span> <span class="n">make_R</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">],</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">)</span><span class="o">*</span><span class="n">ang2bohr</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bix,bij,bjy-&gt;bxy&#39;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">chi</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">alpha</span><span class="p">,</span> <span class="s1">&#39;chi&#39;</span><span class="p">:</span><span class="n">chi</span><span class="p">,</span> <span class="s1">&#39;eta_e&#39;</span><span class="p">:</span> <span class="n">eta_e</span><span class="p">,</span> <span class="s1">&#39;chi_s&#39;</span><span class="p">:</span> <span class="n">chi_s</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="pinnmodelspol_modelspol_etainv_fn">pinn.models.pol_models.pol_etainv_fn</h3>


<div class="doc doc-object doc-function">



<a id="pinn.models.pol_models.pol_etainv_fn"></a>
    <div class="doc doc-contents first">

        <p>The EtaInv model directly predicts the matrix <span class="arithmatex">\(\boldsymbol{\eta}^{-1}\)</span> as </p>
<div class="arithmatex">\[
\begin{aligned}
\boldsymbol{\eta}^{-1} = {\mathbf{B}}^\top \mathbf{B} + c \mathbf{I}
\end{aligned}
\]</div>
<p>where c is a small positive constant and <span class="arithmatex">\(\mathbf{B}\)</span> is the predicted matrix</p>
<div class="arithmatex">\[
\begin{aligned}
B_{ii} &amp;= {}^{1}\mathbb{P}_i  \\
B_{ij} &amp;= \mathbb{I}_{ij},  \quad  \mathrm{for}~~i\neq j \nonumber \\
\mathbb{I}_{ij} &amp;= {}^{1}\mathbb{I}_{ij} + \langle {}^{3}\mathbb{I}_{ijx}, {}^{3}\mathbb{I}_{ijx} \rangle
\end{aligned}
\]</div>

            <details class="quote">
              <summary>Source code in <code>pinn/models/pol_models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@export_pol_model</span><span class="p">(</span><span class="s1">&#39;pol_etainv_model&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pol_etainv_fn</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sa">R</span><span class="sd">&quot;&quot;&quot;The EtaInv model directly predicts the matrix $\boldsymbol{\eta}^{-1}$ as </span>

<span class="sd">   $$</span>
<span class="sd">   \begin{aligned}</span>
<span class="sd">   \boldsymbol{\eta}^{-1} = {\mathbf{B}}^\top \mathbf{B} + c \mathbf{I}</span>
<span class="sd">   \end{aligned}</span>
<span class="sd">   $$</span>

<span class="sd">   where c is a small positive constant and $\mathbf{B}$ is the predicted matrix</span>

<span class="sd">   $$</span>
<span class="sd">   \begin{aligned}</span>
<span class="sd">   B_{ii} &amp;= {}^{1}\mathbb{P}_i  \\</span>
<span class="sd">   B_{ij} &amp;= \mathbb{I}_{ij},  \quad  \mathrm{for}~~i\neq j \nonumber \\</span>
<span class="sd">   \mathbb{I}_{ij} &amp;= {}^{1}\mathbb{I}_{ij} + \langle {}^{3}\mathbb{I}_{ijx}, {}^{3}\mathbb{I}_{ijx} \rangle</span>
<span class="sd">   \end{aligned}</span>
<span class="sd">   $$</span>
<span class="sd">   &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pinn</span> <span class="kn">import</span> <span class="n">get_network</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1">#</span>
    <span class="k">if</span> <span class="s1">&#39;epsilon&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]:</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;epsilon&#39;</span><span class="p">]</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;out_extra&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;i1&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;i3&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}})</span>
    <span class="n">network</span> <span class="o">=</span> <span class="n">get_network</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">])</span>
    <span class="n">tensors</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">ppred</span><span class="p">,</span> <span class="n">ipred</span> <span class="o">=</span> <span class="n">network</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">ipred1</span> <span class="o">=</span> <span class="n">ipred</span><span class="p">[</span><span class="s1">&#39;i1&#39;</span><span class="p">]</span>
    <span class="n">ipred3</span> <span class="o">=</span> <span class="n">ipred</span><span class="p">[</span><span class="s1">&#39;i3&#39;</span><span class="p">]</span>
    <span class="n">i3norm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij,aij-&gt;aj&#39;</span><span class="p">,</span><span class="n">ipred3</span><span class="p">,</span><span class="n">ipred3</span><span class="p">)</span>
    <span class="n">ipred</span> <span class="o">=</span> <span class="n">ipred1</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij,aij-&gt;aj&#39;</span><span class="p">,</span><span class="n">ipred3</span><span class="p">,</span><span class="n">ipred3</span><span class="p">)</span>
    <span class="n">atom_rind</span><span class="p">,</span><span class="n">pair_rind</span> <span class="o">=</span> <span class="n">make_indices</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">nbatch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">nmax</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>

    <span class="n">M</span> <span class="o">=</span> <span class="n">make_offdiag</span><span class="p">(</span><span class="n">pair_rind</span><span class="p">,</span> <span class="n">ipred</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span><span class="n">symmetric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">invariant</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">+=</span> <span class="n">make_diag</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">ppred</span><span class="p">,</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">)</span>
    <span class="n">etaInv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij,aik-&gt;ajk&#39;</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">M</span><span class="p">)</span>
    <span class="n">etaInv</span> <span class="o">+=</span> <span class="n">make_diag</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">)</span><span class="o">*</span><span class="n">eps</span>
    <span class="n">egap</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij-&gt;a&#39;</span><span class="p">,</span><span class="n">etaInv</span><span class="p">)</span>
    <span class="n">chi</span> <span class="o">=</span> <span class="n">make_lrf</span><span class="p">(</span><span class="n">etaInv</span><span class="p">)</span>

    <span class="c1">#chi -&gt; alpha</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">make_R</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">],</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">)</span><span class="o">*</span><span class="n">ang2bohr</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bix,bij,bjy-&gt;bxy&#39;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">chi</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">alpha</span><span class="p">,</span> <span class="s1">&#39;egap&#39;</span><span class="p">:</span> <span class="n">egap</span><span class="p">,</span> <span class="s1">&#39;chi&#39;</span><span class="p">:</span> <span class="n">chi</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="pinnmodelspol_modelspol_local_fn">pinn.models.pol_models.pol_local_fn</h3>


<div class="doc doc-object doc-function">



<a id="pinn.models.pol_models.pol_local_fn"></a>
    <div class="doc doc-contents first">

        <p>The Local model calculates <span class="arithmatex">\(\boldsymbol{\chi}\)</span> and <span class="arithmatex">\(\boldsymbol{\alpha}\)</span> as sums of local predictions 
<span class="arithmatex">\(\boldsymbol{\chi}_i\)</span> and <span class="arithmatex">\(\boldsymbol{\alpha}_i\)</span>. Local predictions are calculated as</p>
<div class="arithmatex">\[
\begin{aligned}
\boldsymbol{\alpha}_i &amp;= - \mathbf{R}^\top \boldsymbol{\chi}_i \mathbf{R}\\
\boldsymbol{\chi}_i &amp;= - \boldsymbol{\Delta}_i^\top \mathbb{I}_{i} \mathbb{I}_{i}^\top \boldsymbol{\Delta}_i\\
\boldsymbol{\Delta}_i &amp;= \mathbf{I} - \mathbf{1}\otimes\mathbf{e}_i^\top
\end{aligned}
\]</div>
<p>where <span class="arithmatex">\(\mathbf{e}_i\)</span> is the <span class="arithmatex">\(i\)</span>:th standard unit vector.</p>

            <details class="quote">
              <summary>Source code in <code>pinn/models/pol_models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@export_pol_model</span><span class="p">(</span><span class="s1">&#39;pol_local_model&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pol_local_fn</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sa">R</span><span class="sd">&quot;&quot;&quot;The Local model calculates $\boldsymbol{\chi}$ and $\boldsymbol{\alpha}$ as sums of local predictions </span>
<span class="sd">       $\boldsymbol{\chi}_i$ and $\boldsymbol{\alpha}_i$. Local predictions are calculated as</span>

<span class="sd">       $$</span>
<span class="sd">       \begin{aligned}</span>
<span class="sd">       \boldsymbol{\alpha}_i &amp;= - \mathbf{R}^\top \boldsymbol{\chi}_i \mathbf{R}\\</span>
<span class="sd">       \boldsymbol{\chi}_i &amp;= - \boldsymbol{\Delta}_i^\top \mathbb{I}_{i} \mathbb{I}_{i}^\top \boldsymbol{\Delta}_i\\</span>
<span class="sd">       \boldsymbol{\Delta}_i &amp;= \mathbf{I} - \mathbf{1}\otimes\mathbf{e}_i^\top</span>
<span class="sd">       \end{aligned}</span>
<span class="sd">       $$</span>

<span class="sd">       where $\mathbf{e}_i$ is the $i$:th standard unit vector. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">tensorflow.math</span> <span class="kn">import</span> <span class="n">unsorted_segment_sum</span>
    <span class="k">def</span> <span class="nf">_form_triplet</span><span class="p">(</span><span class="n">tensors</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns triplet indices [ij, jk], where r_ij, r_jk &lt; r_c&quot;&quot;&quot;</span>
        <span class="n">p_iind</span> <span class="o">=</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;ind_2&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">n_atoms</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;ind_1&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_pairs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;ind_2&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">p_aind</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_pairs</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
        <span class="n">p_rind</span> <span class="o">=</span> <span class="n">p_aind</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">segment_min</span><span class="p">(</span><span class="n">p_aind</span><span class="p">,</span> <span class="n">p_iind</span><span class="p">),</span> <span class="n">p_iind</span><span class="p">)</span>
        <span class="n">t_dense</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">scatter_nd</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">p_iind</span><span class="p">,</span> <span class="n">p_rind</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">p_aind</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">n_atoms</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">p_rind</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">t_dense</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">t_dense</span><span class="p">,</span> <span class="n">p_iind</span><span class="p">)</span>
        <span class="n">t_index</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t_dense</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">t_ijind</span> <span class="o">=</span> <span class="n">t_index</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">t_ikind</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather_nd</span><span class="p">(</span><span class="n">t_dense</span><span class="p">,</span> <span class="n">t_index</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">t_ind</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">t_ijind</span><span class="p">,</span> <span class="n">t_ikind</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t_ind</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;out_extra&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;i1&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;i3&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}})</span>
    <span class="n">network</span> <span class="o">=</span> <span class="n">get_network</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">])</span>
    <span class="n">tensors</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">ppred</span><span class="p">,</span> <span class="n">ipred</span> <span class="o">=</span> <span class="n">network</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">ipred1</span> <span class="o">=</span> <span class="n">ipred</span><span class="p">[</span><span class="s1">&#39;i1&#39;</span><span class="p">]</span>
    <span class="n">ipred3</span> <span class="o">=</span> <span class="n">ipred</span><span class="p">[</span><span class="s1">&#39;i3&#39;</span><span class="p">]</span>
    <span class="n">i3norm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij,aij-&gt;aj&#39;</span><span class="p">,</span><span class="n">ipred3</span><span class="p">,</span><span class="n">ipred3</span><span class="p">)</span>
    <span class="n">ipred</span> <span class="o">=</span> <span class="n">ipred1</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij,aij-&gt;aj&#39;</span><span class="p">,</span><span class="n">ipred3</span><span class="p">,</span><span class="n">ipred3</span><span class="p">)</span>
    <span class="n">ind1</span> <span class="o">=</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;ind_1&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">natoms</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ind1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nbatch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">ind1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">ind2</span> <span class="o">=</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;ind_2&#39;</span><span class="p">]</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">ang2bohr</span>
    <span class="c1"># tmp -&gt; n_atoms x n_pred x 3 -&gt; local &quot;basis&quot; for polarizability</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">unsorted_segment_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;pc,px-&gt;pcx&#39;</span><span class="p">,</span> <span class="n">ipred</span><span class="p">,</span> <span class="n">diff</span><span class="p">),</span> <span class="n">ind2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">natoms</span><span class="p">)</span>
    <span class="n">alpha_i</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;pcx,pcy-&gt;pxy&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">unsorted_segment_sum</span><span class="p">(</span><span class="n">alpha_i</span><span class="p">,</span> <span class="n">ind1</span><span class="p">,</span> <span class="n">nbatch</span><span class="p">)</span>
    <span class="c1"># chi is a bit more expensive to get :(</span>
    <span class="n">aind</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ind1</span><span class="p">))</span>     <span class="c1"># &quot;absolute&quot; pos of atom in batch</span>
    <span class="n">amax</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ind1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rind</span> <span class="o">=</span> <span class="n">aind</span><span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">unsorted_segment_min</span><span class="p">(</span><span class="n">aind</span><span class="p">,</span> <span class="n">ind1</span><span class="p">,</span> <span class="n">nbatch</span><span class="p">),</span> <span class="n">ind1</span><span class="p">)</span>
    <span class="n">nmax</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">rind</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">ind2_b</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ind2_i</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">rind</span><span class="p">,</span> <span class="n">ind2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ind2_j</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">rind</span><span class="p">,</span> <span class="n">ind2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ind3</span> <span class="o">=</span> <span class="n">_form_triplet</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="c1"># this returns [N_tri, 2] array with positions of [idx_ij, idx_ik] in idx2</span>
    <span class="n">ind3_b</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">ind2_b</span><span class="p">,</span> <span class="n">ind3</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ind3_i</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">ind2_i</span><span class="p">,</span> <span class="n">ind3</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ind3_j</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">ind2_j</span><span class="p">,</span> <span class="n">ind3</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ind3_k</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">ind2_j</span><span class="p">,</span> <span class="n">ind3</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">y_ij</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">ipred</span><span class="p">,</span> <span class="n">ind3</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y_ik</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">ipred</span><span class="p">,</span> <span class="n">ind3</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">y_ijk</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;tc,tc-&gt;t&#39;</span><span class="p">,</span> <span class="n">y_ij</span><span class="p">,</span> <span class="n">y_ik</span><span class="p">)</span>
    <span class="n">i_bjk</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ind3_b</span><span class="p">,</span> <span class="n">ind3_j</span><span class="p">,</span> <span class="n">ind3_k</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">i_bji</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ind3_b</span><span class="p">,</span> <span class="n">ind3_j</span><span class="p">,</span> <span class="n">ind3_i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">i_bik</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ind3_b</span><span class="p">,</span> <span class="n">ind3_i</span><span class="p">,</span> <span class="n">ind3_k</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">i_bii</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ind3_b</span><span class="p">,</span> <span class="n">ind3_i</span><span class="p">,</span> <span class="n">ind3_i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span> <span class="n">nmax</span><span class="p">]</span>
    <span class="n">chi</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>\
        <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">scatter_nd</span><span class="p">(</span><span class="n">i_bjk</span><span class="p">,</span> <span class="n">y_ijk</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>\
        <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">scatter_nd</span><span class="p">(</span><span class="n">i_bji</span><span class="p">,</span> <span class="n">y_ijk</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>\
        <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">scatter_nd</span><span class="p">(</span><span class="n">i_bik</span><span class="p">,</span> <span class="n">y_ijk</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>\
        <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">scatter_nd</span><span class="p">(</span><span class="n">i_bii</span><span class="p">,</span> <span class="n">y_ijk</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">,</span> <span class="s1">&#39;chi&#39;</span><span class="p">:</span> <span class="n">chi</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="pinnmodelspol_modelspol_localchi_fn">pinn.models.pol_models.pol_localchi_fn</h3>


<div class="doc doc-object doc-function">



<a id="pinn.models.pol_models.pol_localchi_fn"></a>
    <div class="doc doc-contents first">

        <p>In the Local chi model <span class="arithmatex">\(\boldsymbol{\chi}\)</span> = <span class="arithmatex">\(\boldsymbol{\chi}_\mathrm{s}\)</span> as calculated in the ACKS2 model.</p>

            <details class="quote">
              <summary>Source code in <code>pinn/models/pol_models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@export_pol_model</span><span class="p">(</span><span class="s1">&#39;pol_localchi_model&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pol_localchi_fn</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sa">R</span><span class="sd">&quot;&quot;&quot; In the Local chi model $\boldsymbol{\chi}$ = $\boldsymbol{\chi}_\mathrm{s}$ as calculated in the ACKS2 model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;out_extra&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;i1&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;i3&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}})</span>
    <span class="n">network</span> <span class="o">=</span> <span class="n">get_network</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">])</span>
    <span class="n">tensors</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">ppred</span><span class="p">,</span> <span class="n">ipred</span> <span class="o">=</span> <span class="n">network</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">ipred1</span> <span class="o">=</span> <span class="n">ipred</span><span class="p">[</span><span class="s1">&#39;i1&#39;</span><span class="p">]</span>
    <span class="n">ipred3</span> <span class="o">=</span> <span class="n">ipred</span><span class="p">[</span><span class="s1">&#39;i3&#39;</span><span class="p">]</span>
    <span class="n">i3norm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij,aij-&gt;aj&#39;</span><span class="p">,</span><span class="n">ipred3</span><span class="p">,</span><span class="n">ipred3</span><span class="p">)</span>
    <span class="n">ipred</span> <span class="o">=</span> <span class="n">ipred1</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij,aij-&gt;aj&#39;</span><span class="p">,</span><span class="n">ipred3</span><span class="p">,</span><span class="n">ipred3</span><span class="p">)</span>
    <span class="n">atom_rind</span><span class="p">,</span><span class="n">pair_rind</span> <span class="o">=</span> <span class="n">make_indices</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">nbatch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">nmax</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>

    <span class="c1"># chi -&gt; alpha</span>
    <span class="n">chi</span> <span class="o">=</span> <span class="n">make_offdiag</span><span class="p">(</span><span class="n">pair_rind</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ipred</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span>
                       <span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">invariant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">R</span> <span class="o">=</span> <span class="n">make_R</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">],</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">)</span><span class="o">*</span><span class="n">ang2bohr</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bix,bij,bjy-&gt;bxy&#39;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">chi</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">alpha</span><span class="p">,</span> <span class="s1">&#39;chi&#39;</span><span class="p">:</span><span class="n">chi</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="pinnmodelspol_modelspol_eem_iso_fn">pinn.models.pol_models.pol_eem_iso_fn</h3>


<div class="doc doc-object doc-function">



<a id="pinn.models.pol_models.pol_eem_iso_fn"></a>
    <div class="doc doc-contents first">

        <p>EEM-model with the addition of an isotropic term for the polarizability tensor. </p>
<div class="arithmatex">\[
\begin{aligned}
\boldsymbol{\alpha} &amp;= - \mathbf{R}^\top \boldsymbol{\chi} \mathbf{R} +  \alpha_{\textrm{iso}}\mathbf{I}\\
\alpha_{\textrm{iso}} &amp;= \sum_i {}^{1}\mathbb{P}_{i} 
\end{aligned}
\]</div>

            <details class="quote">
              <summary>Source code in <code>pinn/models/pol_models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@export_pol_model</span><span class="p">(</span><span class="s1">&#39;pol_eem_iso_model&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pol_eem_iso_fn</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sa">R</span><span class="sd">&quot;&quot;&quot;EEM-model with the addition of an isotropic term for the polarizability tensor. </span>

<span class="sd">    $$</span>
<span class="sd">    \begin{aligned}</span>
<span class="sd">    \boldsymbol{\alpha} &amp;= - \mathbf{R}^\top \boldsymbol{\chi} \mathbf{R} +  \alpha_{\textrm{iso}}\mathbf{I}\\</span>
<span class="sd">    \alpha_{\textrm{iso}} &amp;= \sum_i {}^{1}\mathbb{P}_{i} </span>
<span class="sd">    \end{aligned}</span>
<span class="sd">    $$</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;out_extra&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;p1&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}})</span>
    <span class="n">network</span> <span class="o">=</span> <span class="n">get_network</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">])</span>
    <span class="n">tensors</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">ppred</span><span class="p">,</span><span class="n">ipred</span> <span class="o">=</span> <span class="n">network</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">p12</span> <span class="o">=</span> <span class="n">ipred</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">]</span>

    <span class="c1"># construct EEM, using trainale sigma</span>
    <span class="n">atom_rind</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">make_indices</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">nbatch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">nmax</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">sigma_a</span><span class="p">,</span> <span class="n">sigma_e</span> <span class="o">=</span> <span class="n">make_sigma</span><span class="p">(</span><span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;elems&#39;</span><span class="p">],</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;atom_types&#39;</span><span class="p">]):</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sigma/</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">sigma_e</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">cell</span> <span class="o">=</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">tensors</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">ewald_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;ewald_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;kmax&#39;</span><span class="p">,</span> <span class="s1">&#39;rc&#39;</span><span class="p">,</span> <span class="s1">&#39;eta&#39;</span><span class="p">]}</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">make_E</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">],</span> <span class="n">sigma_a</span><span class="p">,</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="n">cell</span><span class="p">,</span>
               <span class="o">**</span><span class="n">ewald_params</span><span class="p">)</span><span class="o">/</span><span class="n">ang2bohr</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">make_diag</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ppred</span><span class="p">),</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">make_dummy</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">)</span>
    <span class="n">eta</span>    <span class="o">=</span> <span class="n">E</span><span class="o">+</span><span class="n">J</span>
    <span class="n">etaInv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">eta</span><span class="o">+</span><span class="n">D</span><span class="p">)</span><span class="o">-</span><span class="n">D</span>
    <span class="n">egap</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij-&gt;a&#39;</span><span class="p">,</span><span class="n">etaInv</span><span class="p">)</span>
    <span class="n">chi</span>    <span class="o">=</span> <span class="n">make_lrf</span><span class="p">(</span><span class="n">etaInv</span><span class="p">)</span>

    <span class="n">R</span> <span class="o">=</span> <span class="n">make_R</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">],</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">)</span><span class="o">*</span><span class="n">ang2bohr</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bix,bij,bjy-&gt;bxy&#39;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">chi</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
    <span class="n">alpha_iso</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">batch_shape</span><span class="o">=</span><span class="p">[</span><span class="n">nbatch</span><span class="p">])</span><span class="o">*</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">unsorted_segment_sum</span><span class="p">(</span><span class="n">p12</span><span class="p">,</span><span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;ind_1&#39;</span><span class="p">],</span><span class="n">nbatch</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
    <span class="n">alpha</span> <span class="o">+=</span> <span class="n">alpha_iso</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">alpha</span><span class="p">,</span> <span class="s1">&#39;alpha_iso&#39;</span><span class="p">:</span><span class="n">alpha_iso</span><span class="p">,</span> <span class="s1">&#39;egap&#39;</span><span class="p">:</span> <span class="n">egap</span><span class="p">,</span> <span class="s1">&#39;chi&#39;</span><span class="p">:</span><span class="n">chi</span><span class="p">,</span> <span class="s1">&#39;eta&#39;</span><span class="p">:</span> <span class="n">eta</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="pinnmodelspol_modelspol_acks2_iso_fn">pinn.models.pol_models.pol_acks2_iso_fn</h3>


<div class="doc doc-object doc-function">



<a id="pinn.models.pol_models.pol_acks2_iso_fn"></a>
    <div class="doc doc-contents first">

        <p>ACKS2-model with the adddition of an isotropic term for the polarizability tensor. </p>
<div class="arithmatex">\[
\begin{aligned}
\boldsymbol{\alpha} &amp;= - \mathbf{R}^\top \boldsymbol{\chi} \mathbf{R} +  \alpha_{\textrm{iso}}\mathbf{I}\\
\alpha_{\textrm{iso}} &amp;= \sum_i {}^{1}\mathbb{P}_{i} 
\end{aligned}
\]</div>

            <details class="quote">
              <summary>Source code in <code>pinn/models/pol_models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@export_pol_model</span><span class="p">(</span><span class="s1">&#39;pol_acks2_iso_model&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pol_acks2_iso_fn</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sa">R</span><span class="sd">&quot;&quot;&quot;ACKS2-model with the adddition of an isotropic term for the polarizability tensor. </span>

<span class="sd">    $$</span>
<span class="sd">    \begin{aligned}</span>
<span class="sd">    \boldsymbol{\alpha} &amp;= - \mathbf{R}^\top \boldsymbol{\chi} \mathbf{R} +  \alpha_{\textrm{iso}}\mathbf{I}\\</span>
<span class="sd">    \alpha_{\textrm{iso}} &amp;= \sum_i {}^{1}\mathbb{P}_{i} </span>
<span class="sd">    \end{aligned}</span>
<span class="sd">    $$</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;out_extra&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;p1&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;i1&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;i3&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}})</span>
    <span class="n">network</span> <span class="o">=</span> <span class="n">get_network</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">])</span>
    <span class="n">tensors</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">ppred</span><span class="p">,</span> <span class="n">ipred</span> <span class="o">=</span> <span class="n">network</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">ipred1</span> <span class="o">=</span> <span class="n">ipred</span><span class="p">[</span><span class="s1">&#39;i1&#39;</span><span class="p">]</span>
    <span class="n">ipred3</span> <span class="o">=</span> <span class="n">ipred</span><span class="p">[</span><span class="s1">&#39;i3&#39;</span><span class="p">]</span>
    <span class="n">i3norm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij,aij-&gt;aj&#39;</span><span class="p">,</span><span class="n">ipred3</span><span class="p">,</span><span class="n">ipred3</span><span class="p">)</span>
    <span class="n">p12</span> <span class="o">=</span> <span class="n">ipred</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">]</span>
    <span class="n">ipred</span> <span class="o">=</span> <span class="n">ipred1</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij,aij-&gt;aj&#39;</span><span class="p">,</span><span class="n">ipred3</span><span class="p">,</span><span class="n">ipred3</span><span class="p">)</span>

    <span class="c1"># construct eta_e, this part should e same with EEM</span>
    <span class="n">atom_rind</span><span class="p">,</span> <span class="n">pair_rind</span> <span class="o">=</span> <span class="n">make_indices</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">nmax</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">nbatch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">sigma_a</span><span class="p">,</span> <span class="n">sigma_e</span> <span class="o">=</span> <span class="n">make_sigma</span><span class="p">(</span><span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;elems&#39;</span><span class="p">],</span> <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;atom_types&#39;</span><span class="p">]):</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sigma/</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">sigma_e</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">cell</span> <span class="o">=</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;cell&#39;</span> <span class="ow">in</span> <span class="n">tensors</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">ewald_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;ewald_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;kmax&#39;</span><span class="p">,</span> <span class="s1">&#39;rc&#39;</span><span class="p">,</span> <span class="s1">&#39;eta&#39;</span><span class="p">]}</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">make_E</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">],</span> <span class="n">sigma_a</span><span class="p">,</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="n">cell</span><span class="p">,</span>
               <span class="o">**</span><span class="n">ewald_params</span><span class="p">)</span><span class="o">/</span><span class="n">ang2bohr</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">make_diag</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ppred</span><span class="p">),</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">)</span>
    <span class="n">eta_e</span> <span class="o">=</span> <span class="n">E</span><span class="o">+</span><span class="n">J</span>

    <span class="c1"># construct chi_s</span>
    <span class="n">chi_s</span> <span class="o">=</span> <span class="n">make_offdiag</span><span class="p">(</span><span class="n">pair_rind</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ipred</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span>
                         <span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">invariant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">I</span>     <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">nmax</span><span class="p">,</span> <span class="n">batch_shape</span><span class="o">=</span><span class="p">[</span><span class="n">nbatch</span><span class="p">])</span>
    <span class="n">chi</span>   <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span>
        <span class="n">I</span><span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bij,bjk-&gt;bik&#39;</span><span class="p">,</span> <span class="n">eta_e</span><span class="p">,</span> <span class="n">chi_s</span><span class="p">),</span> <span class="n">chi_s</span><span class="p">,</span> <span class="n">adjoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">R</span> <span class="o">=</span> <span class="n">make_R</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">],</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">)</span><span class="o">*</span><span class="n">ang2bohr</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bix,bij,bjy-&gt;bxy&#39;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">chi</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
    <span class="n">alpha_iso</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">batch_shape</span><span class="o">=</span><span class="p">[</span><span class="n">nbatch</span><span class="p">])</span><span class="o">*</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">unsorted_segment_sum</span><span class="p">(</span><span class="n">p12</span><span class="p">,</span><span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;ind_1&#39;</span><span class="p">],</span><span class="n">nbatch</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
    <span class="n">alpha</span> <span class="o">+=</span> <span class="n">alpha_iso</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">alpha</span><span class="p">,</span> <span class="s1">&#39;alpha_iso&#39;</span><span class="p">:</span><span class="n">alpha_iso</span><span class="p">,</span> <span class="s1">&#39;chi&#39;</span><span class="p">:</span><span class="n">chi</span><span class="p">,</span> <span class="s1">&#39;eta_e&#39;</span><span class="p">:</span> <span class="n">eta_e</span><span class="p">,</span> <span class="s1">&#39;chi_s&#39;</span><span class="p">:</span> <span class="n">chi_s</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="pinnmodelspol_modelspol_etainv_iso_fn">pinn.models.pol_models.pol_etainv_iso_fn</h3>


<div class="doc doc-object doc-function">



<a id="pinn.models.pol_models.pol_etainv_iso_fn"></a>
    <div class="doc doc-contents first">

        <p>EtaInv-model with the addition of an isotropic term for the polarizability tensor. </p>
<div class="arithmatex">\[
\begin{aligned}
\boldsymbol{\alpha} &amp;= - \mathbf{R}^\top \boldsymbol{\chi} \mathbf{R} +  \alpha_{\textrm{iso}}\mathbf{I}\\
\alpha_{\textrm{iso}} &amp;= \sum_i {}^{1}\mathbb{P}_{i} 
\end{aligned}
\]</div>

            <details class="quote">
              <summary>Source code in <code>pinn/models/pol_models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@export_pol_model</span><span class="p">(</span><span class="s1">&#39;pol_etainv_iso_model&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pol_etainv_iso_fn</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sa">R</span><span class="sd">&quot;&quot;&quot;EtaInv-model with the addition of an isotropic term for the polarizability tensor. </span>

<span class="sd">    $$</span>
<span class="sd">    \begin{aligned}</span>
<span class="sd">    \boldsymbol{\alpha} &amp;= - \mathbf{R}^\top \boldsymbol{\chi} \mathbf{R} +  \alpha_{\textrm{iso}}\mathbf{I}\\</span>
<span class="sd">    \alpha_{\textrm{iso}} &amp;= \sum_i {}^{1}\mathbb{P}_{i} </span>
<span class="sd">    \end{aligned}</span>
<span class="sd">    $$</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pinn</span> <span class="kn">import</span> <span class="n">get_network</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1">#</span>
    <span class="k">if</span> <span class="s1">&#39;epsilon&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]:</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;epsilon&#39;</span><span class="p">]</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;out_extra&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;p1&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;i1&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;i3&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}})</span>
    <span class="n">network</span> <span class="o">=</span> <span class="n">get_network</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">])</span>
    <span class="n">tensors</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">ppred</span><span class="p">,</span> <span class="n">ipred</span> <span class="o">=</span> <span class="n">network</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">p12</span> <span class="o">=</span> <span class="n">ipred</span><span class="p">[</span><span class="s1">&#39;p1&#39;</span><span class="p">]</span>
    <span class="n">ipred1</span> <span class="o">=</span> <span class="n">ipred</span><span class="p">[</span><span class="s1">&#39;i1&#39;</span><span class="p">]</span>
    <span class="n">ipred3</span> <span class="o">=</span> <span class="n">ipred</span><span class="p">[</span><span class="s1">&#39;i3&#39;</span><span class="p">]</span>
    <span class="n">i3norm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij,aij-&gt;aj&#39;</span><span class="p">,</span><span class="n">ipred3</span><span class="p">,</span><span class="n">ipred3</span><span class="p">)</span>
    <span class="n">ipred</span> <span class="o">=</span> <span class="n">ipred1</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij,aij-&gt;aj&#39;</span><span class="p">,</span><span class="n">ipred3</span><span class="p">,</span><span class="n">ipred3</span><span class="p">)</span>
    <span class="n">atom_rind</span><span class="p">,</span><span class="n">pair_rind</span> <span class="o">=</span> <span class="n">make_indices</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">nbatch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">nmax</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>

    <span class="n">M</span> <span class="o">=</span> <span class="n">make_offdiag</span><span class="p">(</span><span class="n">pair_rind</span><span class="p">,</span> <span class="n">ipred</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span><span class="n">symmetric</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">invariant</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">+=</span> <span class="n">make_diag</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">ppred</span><span class="p">,</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">)</span>
    <span class="n">etaInv</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij,aik-&gt;ajk&#39;</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">M</span><span class="p">)</span>
    <span class="n">etaInv</span> <span class="o">+=</span> <span class="n">make_diag</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">)</span><span class="o">*</span><span class="n">eps</span>
    <span class="n">egap</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij-&gt;a&#39;</span><span class="p">,</span><span class="n">etaInv</span><span class="p">)</span>
    <span class="n">chi</span> <span class="o">=</span> <span class="n">make_lrf</span><span class="p">(</span><span class="n">etaInv</span><span class="p">)</span>

    <span class="c1">#chi -&gt; alpha</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">make_R</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">],</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">)</span><span class="o">*</span><span class="n">ang2bohr</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bix,bij,bjy-&gt;bxy&#39;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">chi</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
    <span class="n">alpha_iso</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">batch_shape</span><span class="o">=</span><span class="p">[</span><span class="n">nbatch</span><span class="p">])</span><span class="o">*</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">unsorted_segment_sum</span><span class="p">(</span><span class="n">p12</span><span class="p">,</span><span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;ind_1&#39;</span><span class="p">],</span><span class="n">nbatch</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
    <span class="n">alpha</span> <span class="o">+=</span> <span class="n">alpha_iso</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">alpha</span><span class="p">,</span> <span class="s1">&#39;alpha_iso&#39;</span><span class="p">:</span><span class="n">alpha_iso</span><span class="p">,</span> <span class="s1">&#39;egap&#39;</span><span class="p">:</span> <span class="n">egap</span><span class="p">,</span> <span class="s1">&#39;chi&#39;</span><span class="p">:</span> <span class="n">chi</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="n">M</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="pinnmodelspol_modelspol_local_iso_fn">pinn.models.pol_models.pol_local_iso_fn</h3>


<div class="doc doc-object doc-function">



<a id="pinn.models.pol_models.pol_local_iso_fn"></a>
    <div class="doc doc-contents first">

        <p>Local model with the addition of an isotropic term for the polarizability tensor. </p>
<div class="arithmatex">\[
\begin{aligned}
\boldsymbol{\alpha} &amp;= - \mathbf{R}^\top \boldsymbol{\chi} \mathbf{R} +  \alpha_{\textrm{iso}}\mathbf{I}\\
\alpha_{\textrm{iso}} &amp;= \sum_i {}^{1}\mathbb{P}_{i} 
\end{aligned}
\]</div>

            <details class="quote">
              <summary>Source code in <code>pinn/models/pol_models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@export_pol_model</span><span class="p">(</span><span class="s1">&#39;pol_local_iso_model&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pol_local_iso_fn</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sa">R</span><span class="sd">&quot;&quot;&quot;Local model with the addition of an isotropic term for the polarizability tensor. </span>

<span class="sd">    $$</span>
<span class="sd">    \begin{aligned}</span>
<span class="sd">    \boldsymbol{\alpha} &amp;= - \mathbf{R}^\top \boldsymbol{\chi} \mathbf{R} +  \alpha_{\textrm{iso}}\mathbf{I}\\</span>
<span class="sd">    \alpha_{\textrm{iso}} &amp;= \sum_i {}^{1}\mathbb{P}_{i} </span>
<span class="sd">    \end{aligned}</span>
<span class="sd">    $$</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">tensorflow.math</span> <span class="kn">import</span> <span class="n">unsorted_segment_sum</span>
    <span class="k">def</span> <span class="nf">_form_triplet</span><span class="p">(</span><span class="n">tensors</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns triplet indices [ij, jk], where r_ij, r_jk &lt; r_c&quot;&quot;&quot;</span>
        <span class="n">p_iind</span> <span class="o">=</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;ind_2&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">n_atoms</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;ind_1&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_pairs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;ind_2&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">p_aind</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_pairs</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
        <span class="n">p_rind</span> <span class="o">=</span> <span class="n">p_aind</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">segment_min</span><span class="p">(</span><span class="n">p_aind</span><span class="p">,</span> <span class="n">p_iind</span><span class="p">),</span> <span class="n">p_iind</span><span class="p">)</span>
        <span class="n">t_dense</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">scatter_nd</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">p_iind</span><span class="p">,</span> <span class="n">p_rind</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">p_aind</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">n_atoms</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">p_rind</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">t_dense</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">t_dense</span><span class="p">,</span> <span class="n">p_iind</span><span class="p">)</span>
        <span class="n">t_index</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t_dense</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">t_ijind</span> <span class="o">=</span> <span class="n">t_index</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">t_ikind</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather_nd</span><span class="p">(</span><span class="n">t_dense</span><span class="p">,</span> <span class="n">t_index</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">t_ind</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">t_ijind</span><span class="p">,</span> <span class="n">t_ikind</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t_ind</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;out_extra&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;i1&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;i3&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}})</span>
    <span class="n">network</span> <span class="o">=</span> <span class="n">get_network</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">])</span>
    <span class="n">tensors</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">ppred</span><span class="p">,</span> <span class="n">ipred</span> <span class="o">=</span> <span class="n">network</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">ipred1</span> <span class="o">=</span> <span class="n">ipred</span><span class="p">[</span><span class="s1">&#39;i1&#39;</span><span class="p">]</span>
    <span class="n">ipred3</span> <span class="o">=</span> <span class="n">ipred</span><span class="p">[</span><span class="s1">&#39;i3&#39;</span><span class="p">]</span>
    <span class="n">i3norm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij,aij-&gt;aj&#39;</span><span class="p">,</span><span class="n">ipred3</span><span class="p">,</span><span class="n">ipred3</span><span class="p">)</span>
    <span class="n">ipred</span> <span class="o">=</span> <span class="n">ipred1</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij,aij-&gt;aj&#39;</span><span class="p">,</span><span class="n">ipred3</span><span class="p">,</span><span class="n">ipred3</span><span class="p">)</span>
    <span class="n">ind1</span> <span class="o">=</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;ind_1&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">natoms</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ind1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nbatch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">ind1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">ind2</span> <span class="o">=</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;ind_2&#39;</span><span class="p">]</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;diff&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">ang2bohr</span>
    <span class="c1"># tmp -&gt; n_atoms x n_pred x 3 -&gt; local &quot;basis&quot; for polarizability</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">unsorted_segment_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;pc,px-&gt;pcx&#39;</span><span class="p">,</span> <span class="n">ipred</span><span class="p">,</span> <span class="n">diff</span><span class="p">),</span> <span class="n">ind2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">natoms</span><span class="p">)</span>
    <span class="n">alpha_i</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;pcx,pcy-&gt;pxy&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">unsorted_segment_sum</span><span class="p">(</span><span class="n">alpha_i</span><span class="p">,</span> <span class="n">ind1</span><span class="p">,</span> <span class="n">nbatch</span><span class="p">)</span>
    <span class="n">alpha_iso</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">batch_shape</span><span class="o">=</span><span class="p">[</span><span class="n">nbatch</span><span class="p">])</span><span class="o">*</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">unsorted_segment_sum</span><span class="p">(</span><span class="n">ppred</span><span class="p">,</span><span class="n">ind1</span><span class="p">,</span><span class="n">nbatch</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
    <span class="n">alpha</span> <span class="o">+=</span> <span class="n">alpha_iso</span>
    <span class="c1"># chi is a bit more expensive to get :(</span>
    <span class="n">aind</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ind1</span><span class="p">))</span>     <span class="c1"># &quot;absolute&quot; pos of atom in batch</span>
    <span class="n">amax</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ind1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rind</span> <span class="o">=</span> <span class="n">aind</span><span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">unsorted_segment_min</span><span class="p">(</span><span class="n">aind</span><span class="p">,</span> <span class="n">ind1</span><span class="p">,</span> <span class="n">nbatch</span><span class="p">),</span> <span class="n">ind1</span><span class="p">)</span>
    <span class="n">nmax</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">rind</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">ind2_b</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ind2_i</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">rind</span><span class="p">,</span> <span class="n">ind2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ind2_j</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">rind</span><span class="p">,</span> <span class="n">ind2</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ind3</span> <span class="o">=</span> <span class="n">_form_triplet</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="c1"># this returns [N_tri, 2] array with positions of [idx_ij, idx_ik] in idx2</span>
    <span class="n">ind3_b</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">ind2_b</span><span class="p">,</span> <span class="n">ind3</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ind3_i</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">ind2_i</span><span class="p">,</span> <span class="n">ind3</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ind3_j</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">ind2_j</span><span class="p">,</span> <span class="n">ind3</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ind3_k</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">ind2_j</span><span class="p">,</span> <span class="n">ind3</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">y_ij</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">ipred</span><span class="p">,</span> <span class="n">ind3</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y_ik</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">ipred</span><span class="p">,</span> <span class="n">ind3</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">y_ijk</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;tc,tc-&gt;t&#39;</span><span class="p">,</span> <span class="n">y_ij</span><span class="p">,</span> <span class="n">y_ik</span><span class="p">)</span>
    <span class="n">i_bjk</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ind3_b</span><span class="p">,</span> <span class="n">ind3_j</span><span class="p">,</span> <span class="n">ind3_k</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">i_bji</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ind3_b</span><span class="p">,</span> <span class="n">ind3_j</span><span class="p">,</span> <span class="n">ind3_i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">i_bik</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ind3_b</span><span class="p">,</span> <span class="n">ind3_i</span><span class="p">,</span> <span class="n">ind3_k</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">i_bii</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ind3_b</span><span class="p">,</span> <span class="n">ind3_i</span><span class="p">,</span> <span class="n">ind3_i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span> <span class="n">nmax</span><span class="p">]</span>
    <span class="n">chi</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>\
        <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">scatter_nd</span><span class="p">(</span><span class="n">i_bjk</span><span class="p">,</span> <span class="n">y_ijk</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>\
        <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">scatter_nd</span><span class="p">(</span><span class="n">i_bji</span><span class="p">,</span> <span class="n">y_ijk</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>\
        <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">scatter_nd</span><span class="p">(</span><span class="n">i_bik</span><span class="p">,</span> <span class="n">y_ijk</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>\
        <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">scatter_nd</span><span class="p">(</span><span class="n">i_bii</span><span class="p">,</span> <span class="n">y_ijk</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">,</span> <span class="s1">&#39;alpha_iso&#39;</span><span class="p">:</span> <span class="n">alpha_iso</span><span class="p">,</span> <span class="s1">&#39;chi&#39;</span><span class="p">:</span> <span class="n">chi</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="pinnmodelspol_modelspol_localchi_iso_fn">pinn.models.pol_models.pol_localchi_iso_fn</h3>


<div class="doc doc-object doc-function">



<a id="pinn.models.pol_models.pol_localchi_iso_fn"></a>
    <div class="doc doc-contents first">

        <p>Local chi-model with the addition of an isotropic term for the polarizability tensor. </p>
<div class="arithmatex">\[
\begin{aligned}
\boldsymbol{\alpha} &amp;= - \mathbf{R}^\top \boldsymbol{\chi} \mathbf{R} +  \alpha_{\textrm{iso}}\mathbf{I}\\
\alpha_{\textrm{iso}} &amp;= \sum_i {}^{1}\mathbb{P}_{i} 
\end{aligned}
\]</div>

            <details class="quote">
              <summary>Source code in <code>pinn/models/pol_models.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@export_pol_model</span><span class="p">(</span><span class="s1">&#39;pol_localchi_iso_model&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pol_localchi_iso_fn</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sa">R</span><span class="sd">&quot;&quot;&quot;Local chi-model with the addition of an isotropic term for the polarizability tensor. </span>

<span class="sd">    $$</span>
<span class="sd">    \begin{aligned}</span>
<span class="sd">    \boldsymbol{\alpha} &amp;= - \mathbf{R}^\top \boldsymbol{\chi} \mathbf{R} +  \alpha_{\textrm{iso}}\mathbf{I}\\</span>
<span class="sd">    \alpha_{\textrm{iso}} &amp;= \sum_i {}^{1}\mathbb{P}_{i} </span>
<span class="sd">    \end{aligned}</span>
<span class="sd">    $$</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;out_extra&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;i1&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;i3&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}})</span>
    <span class="n">network</span> <span class="o">=</span> <span class="n">get_network</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">])</span>
    <span class="n">tensors</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">ppred</span><span class="p">,</span> <span class="n">ipred</span> <span class="o">=</span> <span class="n">network</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">ipred1</span> <span class="o">=</span> <span class="n">ipred</span><span class="p">[</span><span class="s1">&#39;i1&#39;</span><span class="p">]</span>
    <span class="n">ipred3</span> <span class="o">=</span> <span class="n">ipred</span><span class="p">[</span><span class="s1">&#39;i3&#39;</span><span class="p">]</span>
    <span class="n">i3norm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij,aij-&gt;aj&#39;</span><span class="p">,</span><span class="n">ipred3</span><span class="p">,</span><span class="n">ipred3</span><span class="p">)</span>
    <span class="n">ipred</span> <span class="o">=</span> <span class="n">ipred1</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aij,aij-&gt;aj&#39;</span><span class="p">,</span><span class="n">ipred3</span><span class="p">,</span><span class="n">ipred3</span><span class="p">)</span>
    <span class="n">atom_rind</span><span class="p">,</span><span class="n">pair_rind</span> <span class="o">=</span> <span class="n">make_indices</span><span class="p">(</span><span class="n">tensors</span><span class="p">)</span>
    <span class="n">nbatch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">nmax</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>

    <span class="c1"># chi -&gt; alpha</span>
    <span class="n">chi</span> <span class="o">=</span> <span class="n">make_offdiag</span><span class="p">(</span><span class="n">pair_rind</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ipred</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span>
                       <span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">invariant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">R</span> <span class="o">=</span> <span class="n">make_R</span><span class="p">(</span><span class="n">atom_rind</span><span class="p">,</span> <span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">],</span> <span class="n">nbatch</span><span class="p">,</span> <span class="n">nmax</span><span class="p">)</span><span class="o">*</span><span class="n">ang2bohr</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bix,bij,bjy-&gt;bxy&#39;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">chi</span><span class="p">,</span> <span class="n">R</span><span class="p">)</span>
    <span class="n">alpha_iso</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">batch_shape</span><span class="o">=</span><span class="p">[</span><span class="n">nbatch</span><span class="p">])</span><span class="o">*</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">unsorted_segment_sum</span><span class="p">(</span><span class="n">ppred</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span><span class="n">tensors</span><span class="p">[</span><span class="s1">&#39;ind_1&#39;</span><span class="p">],</span><span class="n">nbatch</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
    <span class="n">alpha</span> <span class="o">+=</span> <span class="n">alpha_iso</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">alpha</span><span class="p">,</span> <span class="s1">&#39;alpha_iso&#39;</span><span class="p">:</span><span class="n">alpha_iso</span><span class="p">,</span> <span class="s1">&#39;chi&#39;</span><span class="p">:</span><span class="n">chi</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p><sup>1</sup> Y. Shao, L. Andersson, L. Knijff, and C. Zhang, <a href="https://doi.org/10.1088/2516-1075/ac59ca">Finite-field coupling via learning the charge response kernel</a>, Electronic Structure <strong>4</strong>(1), 014012 (2022).&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p><sup>1</sup> W.J. Mortier, K. Van Genechten, and J. Gasteiger, <a href="https://pubs.acs.org/doi/10.1021/ja00290a017">Electronegativity equalization: Application and parametrization</a>, J. Am. Chem. Soc. <strong>107</strong>(4), 829835 (1985).&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p><sup>1</sup> T. Verstraelen, P.W. Ayers, V.V. Speybroeck, and M. Waroquier, <a href="https://doi.org/10.1063/1.4791569">ACKS2: Atom-condensed kohn-sham DFT approximated to second order</a>, J. Chem. Phys. <strong>138</strong>(7), 074108 (2013).&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div>
    </div>

  </div>

  <div class="page">
    <div class="page-prev">
      
      <a href="../dipole/" title="Dipole"><span></span> Previous</a>
      
    </div>
    <div class="page-next">
      
      <a href="../custom_model/" title="Customize" />Next <span></span></a>
      
    </div>
  </div>

  <div class="footer">
    Built with <a href="https://www.mkdocs.org">mkdocs</a> and the <a href="https://github.com/yqshao/mkdocs-flux-theme">flux</a> theme.
  </div>
</body>
</html>